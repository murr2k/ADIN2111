# ADIN2111 QEMU Device Model Documentation

## Overview

The ADIN2111 QEMU device model provides emulation of the Analog Devices ADIN2111 dual-port 10BASE-T1L Ethernet switch with integrated PHYs. This model enables testing of the Linux driver without physical hardware.

## Features

- **SPI Slave Interface**: Full SPI register access emulation
- **Dual PHY Ports**: Two independent 10BASE-T1L Ethernet ports
- **Internal L2 Switch**: Hardware packet forwarding between ports
- **Operating Modes**:
  - Cut-through mode (minimal latency)
  - Store-and-forward mode (buffered)
  - Unmanaged switch mode
  - Dual MAC mode
- **MAC Filtering**: 16-entry MAC address table
- **Statistics**: Per-port packet and byte counters
- **Diagnostics**: Link status, cable test emulation
- **Timing Accurate**: Realistic latency and reset timing from datasheet

## Usage

### Command Line

Basic usage with single network backend:
```bash
qemu-system-arm ... -device adin2111,netdev=net0 -netdev user,id=net0
```

Dual network backend (one per port):
```bash
qemu-system-arm ... \
  -device adin2111,netdev=net0,netdev2=net1 \
  -netdev user,id=net0 \
  -netdev user,id=net1
```

### Device Tree

```dts
&spi0 {
    adin2111@0 {
        compatible = "adi,adin2111";
        reg = <0>;
        spi-max-frequency = <25000000>;
        interrupt-parent = <&gpio>;
        interrupts = <25 IRQ_TYPE_LEVEL_LOW>;
    };
};
```

### Machine Configuration

For custom QEMU machines, add the device programmatically:

```c
/* Create SPI bus */
spi_bus = ssi_create_bus(dev, "spi0");

/* Create ADIN2111 device */
adin2111 = ssi_create_slave(spi_bus, "adin2111");

/* Connect interrupt */
sysbus_connect_irq(SYS_BUS_DEVICE(adin2111), 0, irq);
```

## Register Map

Key registers exposed via SPI:

| Address | Register | Description |
|---------|----------|-------------|
| 0x0000 | CHIP_ID | Chip identification (0x2111) |
| 0x0001 | SCRATCH | Scratchpad for testing |
| 0x0002 | RESET_CTL | Reset control |
| 0x0003 | DEVICE_STATUS | Device and link status |
| 0x0004 | INT_STATUS | Interrupt status |
| 0x0005 | INT_MASK | Interrupt mask |
| 0x0040 | SWITCH_CONFIG | Switch mode configuration |
| 0x0044+ | MAC_TABLE | MAC filtering table |
| 0x0080+ | PORT1_* | Port 1 control/status/stats |
| 0x00A0+ | PORT2_* | Port 2 control/status/stats |

## Testing

### Unit Tests

Run QEMU tests:
```bash
cd qemu/build
meson test adin2111-test
```

### Driver Testing

1. Build kernel with ADIN2111 driver enabled
2. Boot QEMU with device model
3. Load driver module:
```bash
modprobe adin2111
```
4. Verify network interfaces:
```bash
ip link show
```

### Performance Testing

Test switching latency:
```bash
# Terminal 1: Monitor port 1
tcpdump -i eth0 -n

# Terminal 2: Send traffic to port 2
ping -I eth1 192.168.1.100
```

## Implementation Details

### Timing Accuracy

The model implements accurate timing based on the ADIN2111 datasheet Rev. B:

- **Reset Duration**: 50ms (hardware and software reset)
- **Power-on Time**: 43ms typical
- **PHY RX Latency**: 6.4µs
- **Switch Latency**: 12.6µs (store-and-forward), 6.3µs (cut-through)
- **PHY TX Latency**: 3.2µs
- **Total Port-to-Port**: 22.2µs typical

### SPI Protocol

The model implements the ADIN2111 SPI protocol:
1. Command byte (read/write bit + register address high)
2. Address low byte
3. Data bytes (4 bytes for 32-bit registers)

### Switch Behavior

In switch mode, packets received on one port are automatically forwarded to:
- The other port (if destination MAC matches or broadcast)
- The host (if destination MAC is local)
- Both (if broadcast/multicast)

MAC learning is optionally supported with a 16-entry table.

## Limitations

Current limitations of the QEMU model:

1. **No IEEE 1588 PTP**: Timestamp registers present but not functional
2. **Simplified PHY**: No cable diagnostics or TDR results
3. **No Power Management**: All power states report as active
4. **Fixed Link Speed**: Always reports 10Mbps
5. **No VLAN Support**: VLAN tagging not implemented

## Debugging

Enable debug output:
```bash
qemu-system-arm ... -d guest_errors -D /tmp/adin2111.log
```

Monitor SPI transactions:
```bash
qemu-system-arm ... -trace adin2111_spi_transfer
```

## Contributing

The ADIN2111 QEMU model is maintained as part of the Linux driver project.

Report issues: https://github.com/murr2k/ADIN2111/issues

## License

Copyright (c) 2025 Murray Kopit <murr2k@gmail.com>
Licensed under GNU GPL version 2 or later.